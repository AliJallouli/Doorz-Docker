-- Table pour les types d'usages (ex. : Register, ContactForm, PostListing)
CREATE TABLE legal_document_usage (
    usage_id INT AUTO_INCREMENT PRIMARY KEY COMMENT 'Identifiant unique de l’usage',
    name VARCHAR(100) NOT NULL UNIQUE COMMENT 'Nom de l’usage (ex. : Register, ContactForm)',
    description TEXT COMMENT 'Description de l’usage',
    INDEX idx_name (name) COMMENT 'Index pour recherches par nom'
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci
  COMMENT='Usages associés aux documents légaux';

-- Table pour associer les types de documents légaux à des usages
CREATE TABLE legal_document_usage_type (
    document_usage_id INT AUTO_INCREMENT PRIMARY KEY COMMENT 'Identifiant unique de l’association document-usage',
    document_type_id INT NOT NULL COMMENT 'Type de document légal associé',
    usage_id INT NOT NULL COMMENT 'Usage associé',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Date de création de l’association',
    UNIQUE (document_type_id, usage_id) COMMENT 'Garantit une seule association par type de document et usage',
    FOREIGN KEY (document_type_id) REFERENCES legal_document_type(document_type_id) ON DELETE CASCADE,
    FOREIGN KEY (usage_id) REFERENCES legal_document_usage(usage_id) ON DELETE CASCADE,
    INDEX idx_document_usage (document_type_id, usage_id) COMMENT 'Index pour recherches par type de document et usage'
) ENGINE=InnoDB
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci
  COMMENT='Associations entre types de documents légaux et usages';
  

 
ALTER TABLE user_legal_consent
ADD COLUMN usage_id INT COMMENT 'Usage associé au consentement',
ADD FOREIGN KEY (usage_id) REFERENCES legal_document_usage(usage_id) ON DELETE SET NULL,
ADD INDEX idx_usage_id (usage_id) COMMENT 'Index pour recherches par usage';

-- Usages
INSERT INTO legal_document_usage (name, description) VALUES
('Register', 'Inscription d’un nouvel utilisateur'),
('Contact', 'Utilisation du formulaire de contact'),
('RentKot', 'Réservation ou location d’un kot'),
('ManageAccount', 'Gestion des paramètres du compte utilisateur'),
('PostListing', 'Publication d’une annonce (kot, job, stage)'),
('ApplyJob', 'Postuler à une offre d’emploi ou un stage'),
('NewsletterSubscription', 'Inscription à la newsletter ou notifications');

-- Associations types de documents-usages
INSERT INTO legal_document_usage_type (document_type_id, usage_id) VALUES
-- Register: Inscription nécessite CGU et politique de confidentialité
((SELECT document_type_id FROM legal_document_type WHERE name = 'PrivacyPolicy'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'Register')),
((SELECT document_type_id FROM legal_document_type WHERE name = 'TermsOfService'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'Register')),
-- Contact: Formulaire de contact nécessite CGU et mentions légales
((SELECT document_type_id FROM legal_document_type WHERE name = 'TermsOfService'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'Contact')),
((SELECT document_type_id FROM legal_document_type WHERE name = 'LegalNotice'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'Contact')),
-- RentKot: Réservation d’un kot nécessite CGU et politique de confidentialité
((SELECT document_type_id FROM legal_document_type WHERE name = 'TermsOfService'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'RentKot')),
((SELECT document_type_id FROM legal_document_type WHERE name = 'PrivacyPolicy'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'RentKot')),
-- ManageAccount: Gestion du compte nécessite politique de confidentialité
((SELECT document_type_id FROM legal_document_type WHERE name = 'PrivacyPolicy'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'ManageAccount')),
-- PostListing: Publication d’annonce nécessite CGU et politique de confidentialité
((SELECT document_type_id FROM legal_document_type WHERE name = 'TermsOfService'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'PostListing')),
((SELECT document_type_id FROM legal_document_type WHERE name = 'PrivacyPolicy'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'PostListing')),
-- ApplyJob: Candidature nécessite CGU et politique de confidentialité
((SELECT document_type_id FROM legal_document_type WHERE name = 'PrivacyPolicy'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'ApplyJob')),
((SELECT document_type_id FROM legal_document_type WHERE name = 'TermsOfService'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'ApplyJob')),
-- NewsletterSubscription: Newsletter nécessite politique de confidentialité
((SELECT document_type_id FROM legal_document_type WHERE name = 'PrivacyPolicy'), 
 (SELECT usage_id FROM legal_document_usage WHERE name = 'NewsletterSubscription'));